name: Staging Uptime Monitor

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  # Also run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Check health endpoint
        id: health
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://relay-beta-api.railway.app/health)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi

          echo "âœ… Health check passed (HTTP $HTTP_CODE)"

      - name: Check API response time
        id: performance
        run: |
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://relay-beta-api.railway.app/health)

          # Convert to milliseconds
          RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc)

          echo "âœ… API response time: ${RESPONSE_MS}ms"

          # Warn if response time > 1 second
          if (( $(echo "$RESPONSE_TIME > 1" | bc -l) )); then
            echo "âš ï¸ Warning: Response time is slower than expected (>1s)"
          fi

      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Staging Service Downtime Detected';
            const body = `
            ## Staging Service Alert

            **Time:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}

            ### Failed Checks
            ${context.job}

            ### Action Required
            1. Check Railway logs: \`railway logs --lines 100\`
            2. Verify service status: \`railway status\`
            3. Check deployment: https://railway.app/project/relay

            ### Quick Diagnosis
            \`\`\`bash
            curl https://relay-beta-api.railway.app/health
            curl -I https://relay-beta-api.railway.app/health
            \`\`\`

            [View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'uptime-alert',
              per_page: 1
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['uptime-alert', 'staging', 'incident']
              });
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another failure detected at ${new Date().toISOString()}\n\n[View run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            }
