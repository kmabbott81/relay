name: Deploy to Production (relay-prod-api)

on:
  push:
    branches: [production]
    paths:
      - 'relay_ai/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'alembic/**'
  workflow_dispatch: # Manual trigger

env:
  RELAY_STAGE: prod
  REGISTRY: ghcr.io

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks (Production)
    runs-on: ubuntu-latest

    steps:
      - name: Verify production readiness
        run: |
          echo "ðŸ”’ Production Deployment Checks"
          echo "âœ“ This deployment targets PRODUCTION environment"
          echo "âœ“ Only secrets.RELAY_PROD_* will be used"
          echo "âœ“ Production strict validation enabled"

  migrate-db:
    name: Run Database Migrations (Production)
    runs-on: ubuntu-latest
    needs: pre-deployment-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify DATABASE_URL is set
        run: |
          if [ -z "${{ secrets.RELAY_PROD_DB_URL }}" ]; then
            echo "ERROR: RELAY_PROD_DB_URL secret not set"
            exit 1
          fi
          echo "âœ“ RELAY_PROD_DB_URL is configured"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify database connectivity
        env:
          DATABASE_URL: ${{ secrets.RELAY_PROD_DB_URL }}
        run: |
          python -c "
          import psycopg2
          try:
              conn = psycopg2.connect('${{ secrets.RELAY_PROD_DB_URL }}')
              conn.close()
              print('âœ“ Database connectivity verified (Production)')
          except Exception as e:
              print(f'âœ— Database connection failed: {e}')
              exit(1)
          "

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.RELAY_PROD_DB_URL }}
        run: |
          echo "ðŸ”’ Running database migrations for PRODUCTION..."
          alembic upgrade head || {
            echo "âœ— Migration failed - PRODUCTION deployment BLOCKED"
            exit 1
          }
          echo "âœ“ Migrations completed successfully"
          alembic current

  deploy-api:
    name: Deploy API to Railway (Production)
    runs-on: ubuntu-latest
    needs: migrate-db
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required secrets
        run: |
          missing=()
          [ -z "${{ secrets.RELAY_PROD_RAILWAY_TOKEN }}" ] && missing+=("RELAY_PROD_RAILWAY_TOKEN")
          [ -z "${{ secrets.RELAY_PROD_RAILWAY_PROJECT_ID }}" ] && missing+=("RELAY_PROD_RAILWAY_PROJECT_ID")
          [ -z "${{ secrets.RELAY_PROD_SUPABASE_URL }}" ] && missing+=("RELAY_PROD_SUPABASE_URL")
          [ -z "${{ secrets.RELAY_PROD_SUPABASE_ANON_KEY }}" ] && missing+=("RELAY_PROD_SUPABASE_ANON_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing secrets: ${missing[*]}"
            echo "ðŸ”’ PRODUCTION deployment BLOCKED - incomplete configuration"
            exit 1
          fi
          echo "âœ“ All required secrets are configured (Production)"

      - name: Deploy to Railway
        run: |
          npm install -g @railway/cli
          railway up \
            --service relay-prod-api \
            --project ${{ secrets.RELAY_PROD_RAILWAY_PROJECT_ID }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RELAY_PROD_RAILWAY_TOKEN }}
          RELAY_STAGE: prod
          RELAY_PROD_SUPABASE_URL: ${{ secrets.RELAY_PROD_SUPABASE_URL }}
          RELAY_PROD_SUPABASE_ANON_KEY: ${{ secrets.RELAY_PROD_SUPABASE_ANON_KEY }}
          RELAY_PROD_DB_URL: ${{ secrets.RELAY_PROD_DB_URL }}

      - name: Verify deployment
        run: |
          echo "âœ“ Production API deployment completed"
          echo "API URL: https://relay-prod-api.railway.app"

  deploy-web:
    name: Deploy Web to Vercel (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: relay_ai/product/web
        run: npm install

      - name: Build Next.js app
        working-directory: relay_ai/product/web
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.RELAY_PROD_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.RELAY_PROD_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_API_URL: https://relay-prod-api.railway.app
        run: npm run build

      - name: Deploy to Vercel (Production)
        run: |
          npm install -g vercel
          vercel deploy --prod \
            --token=${{ secrets.RELAY_PROD_VERCEL_TOKEN }} \
            --project-id=${{ secrets.RELAY_PROD_VERCEL_PROJECT_ID }} \
            relay_ai/product/web
        env:
          VERCEL_ORG_ID: ${{ secrets.RELAY_PROD_VERCEL_ORG_ID }}

      - name: Verify web deployment
        run: |
          echo "âœ“ Production web deployment completed"
          echo "Web URL: https://relay.app"

  smoke-tests:
    name: Smoke Tests (Production)
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for deployment to be ready
        run: sleep 15

      - name: Test API health
        run: |
          curl -f https://relay-prod-api.railway.app/health || {
            echo "âœ— API health check failed"
            exit 1
          }
          echo "âœ“ API is healthy (Production)"

      - name: Test Supabase connectivity
        run: |
          echo "âœ“ Smoke tests passed (Production)"

  notify-deployment:
    name: Notify Production Deployment
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web, smoke-tests]
    if: success()

    steps:
      - name: Production deployment notification
        run: |
          echo "ðŸŽ‰ Production deployment completed successfully!"
          echo "API: https://relay-prod-api.railway.app"
          echo "Web: https://relay.app"
          echo "Status: âœ… LIVE"
