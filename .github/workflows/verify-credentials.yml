name: Verify Rotated Credentials

on:
  workflow_dispatch:  # Manual trigger only
  schedule:
    # Weekly verification (Sundays at 2 AM UTC)
    - cron: '0 2 * * 0'

jobs:
  verify-credentials:
    name: Verify API Keys and Database Connection
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai anthropic psycopg2-binary

      - name: Verify OpenAI API Key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys

          api_key = os.getenv('OPENAI_API_KEY')

          if not api_key:
              print("❌ OPENAI_API_KEY not set in GitHub Secrets")
              sys.exit(1)

          if not api_key.startswith('sk-proj-'):
              print("❌ OPENAI_API_KEY has unexpected format (should start with sk-proj-)")
              sys.exit(1)

          # Mask key in output
          masked_key = api_key[:20] + '...' + api_key[-4:]
          print(f"✓ OPENAI_API_KEY configured: {masked_key}")
          EOF

      - name: Verify Anthropic API Key
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys

          api_key = os.getenv('ANTHROPIC_API_KEY')

          if not api_key:
              print("❌ ANTHROPIC_API_KEY not set in GitHub Secrets")
              sys.exit(1)

          if not api_key.startswith('sk-ant-'):
              print("❌ ANTHROPIC_API_KEY has unexpected format (should start with sk-ant-)")
              sys.exit(1)

          # Mask key in output
          masked_key = api_key[:20] + '...' + api_key[-4:]
          print(f"✓ ANTHROPIC_API_KEY configured: {masked_key}")
          EOF

      - name: Verify Database Connection (Beta)
        env:
          DATABASE_URL: ${{ secrets.RELAY_BETA_DB_URL }}
        run: |
          python << 'EOF'
          import os
          import sys
          import psycopg2

          db_url = os.getenv('DATABASE_URL')

          if not db_url:
              print("❌ RELAY_BETA_DB_URL not set in GitHub Secrets")
              sys.exit(1)

          try:
              conn = psycopg2.connect(db_url)
              cursor = conn.cursor()
              cursor.execute('SELECT version();')
              version_info = cursor.fetchone()
              conn.close()

              pg_version = version_info[0].split(',')[0]

              # Mask connection string for display
              display_url = db_url.split('@')[1] if '@' in db_url else 'postgresql://...'

              print(f"✓ Database connection successful")
              print(f"  Host: {display_url}")
              print(f"  PostgreSQL: {pg_version}")
          except Exception as e:
              print(f"❌ Database connection failed: {e}")
              sys.exit(1)
          EOF

      - name: Test OpenAI API Call
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          from openai import OpenAI

          try:
              client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

              # Simple test call (low token usage)
              response = client.models.list()

              print(f"✓ OpenAI API working (found {len(response.data)} models)")
          except Exception as e:
              print(f"❌ OpenAI API test failed: {e}")
              sys.exit(1)
          EOF

      - name: Test Anthropic API Call
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          from anthropic import Anthropic

          try:
              client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

              # Simple test call (low token usage, using haiku for minimal cost)
              response = client.messages.create(
                  model="claude-haiku-4-5-20251001",
                  max_tokens=10,
                  messages=[
                      {"role": "user", "content": "Say 'working'"}
                  ]
              )

              print(f"✓ Anthropic API working: {response.content[0].text}")
          except Exception as e:
              print(f"❌ Anthropic API test failed: {e}")
              sys.exit(1)
          EOF

      - name: Create success summary
        if: success()
        run: |
          echo "## ✓ Credential Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All API keys and database credentials verified:" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ OpenAI API Key" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Anthropic API Key" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ PostgreSQL Database (Beta)" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ OpenAI API Call Test" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Anthropic API Call Test" >> $GITHUB_STEP_SUMMARY

      - name: Create failure summary
        if: failure()
        run: |
          echo "## ❌ Credential Verification Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check GitHub Secrets for:" >> $GITHUB_STEP_SUMMARY
          echo "- OPENAI_API_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- ANTHROPIC_API_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- RELAY_BETA_DB_URL" >> $GITHUB_STEP_SUMMARY
